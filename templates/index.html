{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>D3 Demo: Bar chart with random values</title>
    <script type="text/javascript" src="{% static 'd3/d3.v3.min.js' %}"></script>
    <style type="text/css">
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: auto;
            position: relative;
            width: 1500px;
        }

        form {
            position: absolute;
            right: 10px;
            top: 10px;
        }

        .node {
            border: solid 1px white;
            font: 12px sans-serif;

            line-height: 12px;
            overflow: hidden;
            position: absolute;
            text-indent: 2px;
        }

        .node_text{
            margin-top:3px;

        }

        .detail_text{
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 15px;
            white-space: pre-wrap;
        }

        .detail_message{
            width:auto;
            height:auto;
        }


    </style>
</head>
<body>
<h1> NewsFeed Visualization </h1>
<form>
    <label><input type="radio" name="mode" value="size" checked> Size</label>
    <label><input type="radio" name="mode" value="count"> Count</label>
</form>
<script type="text/javascript">
    var margin = {top: 40, right: 10, bottom: 10, left: 10},
            width = 1500 - margin.left - margin.right,
            height = 700 - margin.top - margin.bottom;

    var color = d3.scale.category20c();

    var treemap = d3.layout.treemap()
            .size([width, height])
            .sticky(true)
            .value(function(d) { return d.size; });

    var color_code = d3.select("body").append("div")
                        .style("position", "relative")
                        .style("left", margin.left + "px");

    var div = d3.select("body").append("div")
            .style("position", "relative")
            .style("width", (width + margin.left + margin.right) + "px")
            .style("height", (height + margin.top + margin.bottom) + "px")
            .style("left", margin.left + "px")
            .style("top", margin.top + "px");


    var detail_info = d3.select("body").append("div")
                        .style("position", "relative")
                        .style("margin-top", "20px")
                        .style("left", margin.left + "px")
            .style("width", "1200px");

    var detail_sub_info = detail_info.append("div").style("width", "1200px").style("height", "100px");

    var detail_img = detail_sub_info.append("img").attr("width", 50 + 'px').attr("height", 50 + 'px').style("float", "left");
    var detail_author = detail_sub_info.append("p").style("float", "left").style("margin-left", "10px").attr("class", "detail_text");

    var detail_message = detail_sub_info.append("pre").style("float", "left")
            .attr("class", "detail_message")
            .style("width", "1000px")
            .style("margin-top", "5px")
            .style("margin-left", "10px").attr("class", "detail_text");


    var detail_picture = detail_info.append("img")

    d3.json("/treemap_data", function(error, root) {
        var release_dates = root['children'].map(function(d){ return d['name']});


        if (error) throw error;


        //Color Code
        var color_code_div = color_code.selectAll("div")
                .data(release_dates)
                .enter()
                .append("div")
                .style("position", "relative")
                .style("width", 300 + 'px')
                .style("height", 10 + 'px')
                .style("margin-top", 5 + 'px');


                color_code_div.append("div")
                        .style("position", "relative")
                        .style("top", 0 + 'px')
                    .style("width", 50 + 'px')
                .style("height", 10 + 'px')

                .style("background-color", function(d){
                    return color(d)
                })

                color_code_div.append("div")
                        .style("position", "relative")
                        .style("left", 60 + 'px')
                        .style("top", -15 + 'px')
                        .style("width", 100 + 'px')
                        .style("height", 10 + 'px')
                .text(function(d) {
                    return d;
                });


        //Mouse Over
        var node = div.datum(root).selectAll(".node")
                .data(treemap.nodes)
                .enter().append("div")
                .attr("class", "node")
                .call(position)
                .style("background-color", function(d) {

                    if(d.type == 'type')
                        return color(d.name);
                    else if(d.type == 'date')
                        return color(d.name);
                    else
                        return null;

                })
                .on("mouseover", function(d){
                    //Detail Information
                    console.log(d.picture_url);
                    detail_picture.attr("src", d.picture_url);
                    detail_img.attr("src", d.author_img_url);
                    detail_author.text(d.author);
                    detail_message.text(d.message);

                })

                .style("opacity", function(d){
                    if(d.type == 'type')
                        return 0.15;
                    else
                        return null;
                })
                .append("div")
                .attr("class", "node_text")
                .text(function(d) {

                    return d.type == 'author'?  d.name : null;

                });



        d3.selectAll("input").on("change", function change() {
            var value = this.value === "count"
                    ? function() { return 1; }
                    : function(d) { return d.size; };

            node.data(treemap.value(value).nodes)
                .transition()
                .duration(1500)
                .call(position);
        });





    });

    function position() {
        this.style("left", function(d) { return d.x + "px"; })
                .style("top", function(d) { return d.y + "px"; })
                .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
                .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
    }
</script>
</body>
</html>